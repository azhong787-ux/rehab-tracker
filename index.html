<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>åº·å¤è¿½è¸ª</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #F5F5F5;
            color: #333;
            padding-bottom: 70px;
        }

        /* é¡¶éƒ¨æ ‡é¢˜æ  */
        .header {
            background: #5B9BD5;
            color: white;
            padding: 15px 20px;
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        /* é¡µé¢å®¹å™¨ */
        .page {
            display: none;
            padding: 20px;
        }

        .page.active {
            display: block;
        }

        /* å¡ç‰‡ */
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        /* å¤§æŒ‰é’® */
        .btn-primary {
            background: #5B9BD5;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: block;
            margin: 20px auto;
            width: 200px;
        }

        .btn-primary:active {
            opacity: 0.8;
        }

        .btn-secondary {
            background: white;
            color: #5B9BD5;
            border: 2px solid #5B9BD5;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: inline-block;
            margin: 5px;
        }

        .btn-secondary:active {
            background: #E8F4F8;
        }

        /* é¦–é¡µæ ·å¼ */
        .date-display {
            text-align: center;
            font-size: 16px;
            color: #666;
            margin: 10px 0;
        }

        .streak-info {
            text-align: center;
            margin: 20px 0;
            font-size: 14px;
            color: #70AD47;
        }

        .streak-number {
            font-size: 24px;
            font-weight: bold;
        }

        /* æé†’åˆ—è¡¨ */
        .reminder-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }

        .reminder-item:last-child {
            border-bottom: none;
        }

        .checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid #ddd;
            border-radius: 4px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .checkbox.checked {
            background: #70AD47;
            border-color: #70AD47;
            color: white;
        }

        /* æ‰“å¡é¡µæ ·å¼ */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 10px;
            display: block;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .slider {
            flex: 1;
            height: 8px;
            border-radius: 4px;
            background: #ddd;
            appearance: none;
        }

        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #5B9BD5;
            cursor: pointer;
        }

        .score-display {
            font-size: 18px;
            font-weight: bold;
            color: #5B9BD5;
            min-width: 50px;
            text-align: center;
        }

        .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .radio-btn {
            flex: 1;
            min-width: 70px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            text-align: center;
            font-size: 14px;
            cursor: pointer;
        }

        .radio-btn.selected {
            border-color: #5B9BD5;
            background: #E8F4F8;
            color: #5B9BD5;
            font-weight: 600;
        }

        .counter {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .counter-btn {
            width: 44px;
            height: 44px;
            border: 2px solid #ddd;
            border-radius: 50%;
            background: white;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .counter-value {
            font-size: 24px;
            font-weight: bold;
            min-width: 40px;
            text-align: center;
        }

        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
        }

        textarea:focus {
            outline: none;
            border-color: #5B9BD5;
        }

        /* è®°å½•é¡µæ ·å¼ */
        .record-item {
            padding: 15px 0;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .record-item:last-child {
            border-bottom: none;
        }

        .record-date {
            font-size: 12px;
            color: #999;
            margin-bottom: 5px;
        }

        .record-score {
            font-size: 14px;
            font-weight: 600;
            color: #5B9BD5;
        }

        .record-details {
            font-size: 13px;
            color: #666;
            margin-top: 5px;
        }

        .record-notes {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
            font-style: italic;
        }

        .empty {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        /* æ–¹æ¡ˆé¡µæ ·å¼ */
        .section {
            margin-bottom: 15px;
        }

        .section-title {
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .section-content {
            background: white;
            margin-top: 10px;
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 14px;
            line-height: 1.6;
            display: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .section-content.show {
            display: block;
        }

        .section-item {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .section-item:last-child {
            border-bottom: none;
        }

        /* åº•éƒ¨å¯¼èˆª */
        .tabbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            padding-bottom: max(8px, env(safe-area-inset-bottom));
        }

        .tab-item {
            flex: 1;
            text-align: center;
            font-size: 11px;
            color: #999;
            cursor: pointer;
            padding: 5px 0;
        }

        .tab-item.active {
            color: #5B9BD5;
        }

        .tab-icon {
            font-size: 24px;
            margin-bottom: 2px;
        }

        /* ç»Ÿè®¡å›¾è¡¨ */
        .chart-container {
            height: 250px;
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .chart-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .chart-wrapper {
            height: 200px;
            position: relative;
        }

        /* ç»Ÿè®¡æ•°æ® */
        .stat-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-icon {
            font-size: 16px;
            margin-right: 12px;
        }

        .stat-label {
            flex: 1;
            font-size: 14px;
            color: #666;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        /* æˆ‘çš„é¡µé¢ */
        .user-card {
            text-align: center;
            padding: 30px 20px;
        }

        .user-avatar {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .user-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .user-days {
            font-size: 13px;
            color: #999;
        }

        .menu-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 0;
            cursor: pointer;
        }

        .menu-item:last-child {
            padding-bottom: 0;
        }

        .menu-text {
            font-size: 15px;
            color: #333;
        }

        .menu-arrow {
            font-size: 14px;
            color: #999;
        }

        .divider {
            height: 1px;
            background: #eee;
            margin: 10px 0;
        }

        .footer-text {
            font-size: 12px;
            color: #999;
            text-align: center;
            line-height: 1.6;
        }

        /* Toast æç¤º */
        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            display: none;
        }

        .toast.show {
            display: block;
        }

        /* å¼€å…³ */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider-switch {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 28px;
        }

        .slider-switch:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider-switch {
            background-color: #5B9BD5;
        }

        input:checked + .slider-switch:before {
            transform: translateX(22px);
        }
    </style>
</head>
<body>
    <!-- Toast æç¤º -->
    <div class="toast" id="toast"></div>

    <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
    <div class="header" id="header">åº·å¤è¿½è¸ª</div>

    <!-- é¦–é¡µ -->
    <div class="page active" id="page-home">
        <div class="date-display" id="currentDate"></div>

        <div class="card">
            <div style="text-align: center; padding: 20px 0;">
                <div style="font-size: 16px; margin-bottom: 15px;" id="checkinPrompt">ä»Šå¤©æ‰“å¡äº†å—ï¼Ÿ</div>
                <button class="btn-primary" onclick="showPage('checkin')">ç«‹å³æ‰“å¡</button>
            </div>
        </div>

        <div class="card">
            <div class="streak-info">
                <div>å·²è¿ç»­åšæŒ</div>
                <div class="streak-number" id="streakDays">0 å¤©</div>
            </div>
        </div>

        <div class="card">
            <div class="form-label">ä»Šæ—¥æé†’</div>
            <div class="reminder-item">
                <div class="checkbox" onclick="toggleCheck(this)" data-reminder="chinTuck">âœ“</div>
                <div>
                    <div style="font-weight: 600;">æ”¶é¢Œè®­ç»ƒ</div>
                    <div style="font-size: 12px; color: #999;">æ¯å°æ—¶ä¸€æ¬¡</div>
                </div>
            </div>
            <div class="reminder-item">
                <div class="checkbox" onclick="toggleCheck(this)" data-reminder="thoracic">âœ“</div>
                <div>
                    <div style="font-weight: 600;">èƒ¸æ¤ä¼¸å±•</div>
                    <div style="font-size: 12px; color: #999;">15:00</div>
                </div>
            </div>
            <div class="reminder-item">
                <div class="checkbox" onclick="toggleCheck(this)" data-reminder="breathing">âœ“</div>
                <div>
                    <div style="font-weight: 600;">ç¡å‰å‘¼å¸</div>
                    <div style="font-size: 12px; color: #999;">22:00</div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ‰“å¡é¡µ -->
    <div class="page" id="page-checkin">
        <div class="card">
            <div class="form-group">
                <label class="form-label">æ—©èµ·æ¸…é†’è¯„åˆ†</label>
                <div class="slider-container">
                    <input type="range" class="slider" min="1" max="10" value="7" id="scoreSlider" oninput="updateScore()">
                    <div class="score-display" id="scoreDisplay">7</div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">è„‘é¸£éŸ³é‡</label>
                <div class="radio-group" id="volumeGroup">
                    <div class="radio-btn" onclick="selectRadio('volumeGroup', this, 0)">æ— </div>
                    <div class="radio-btn" onclick="selectRadio('volumeGroup', this, 1)">è½»å¾®</div>
                    <div class="radio-btn selected" onclick="selectRadio('volumeGroup', this, 2)">ä¸­ç­‰</div>
                    <div class="radio-btn" onclick="selectRadio('volumeGroup', this, 3)">ä¸¥é‡</div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">è„‘é¸£é¢‘ç‡</label>
                <div class="radio-group" id="freqGroup">
                    <div class="radio-btn" onclick="selectRadio('freqGroup', this, 0)">æ— </div>
                    <div class="radio-btn selected" onclick="selectRadio('freqGroup', this, 1)">å¶å°”</div>
                    <div class="radio-btn" onclick="selectRadio('freqGroup', this, 2)">æŒç»­</div>
                    <div class="radio-btn" onclick="selectRadio('freqGroup', this, 3)">æ•´å¤œ</div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">è†ç›–å¼¹å“æ¬¡æ•°</label>
                <div class="counter">
                    <div class="counter-btn" onclick="updateCounter(-1)">âˆ’</div>
                    <div class="counter-value" id="counterValue">5</div>
                    <div class="counter-btn" onclick="updateCounter(1)">+</div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">å¤‡æ³¨ï¼ˆæ´—é¼»/é‡åŠ›æ¯¯/ç‰¹æ®Šæƒ…å†µï¼‰</label>
                <textarea id="notesInput" placeholder="è®°å½•ä»Šå¤©çš„æƒ…å†µ..."></textarea>
            </div>

            <button class="btn-primary" onclick="saveCheckin()">ä¿å­˜æ‰“å¡</button>
        </div>
    </div>

    <!-- è®°å½•é¡µ -->
    <div class="page" id="page-history">
        <div class="card" id="recordsCard">
            <div class="empty">
                <div class="empty-icon">ğŸ“‹</div>
                <div>è¿˜æ²¡æœ‰æ‰“å¡è®°å½•</div>
                <div style="font-size: 12px; margin-top: 10px;">å¼€å§‹ç¬¬ä¸€æ¬¡æ‰“å¡å§</div>
            </div>
        </div>
    </div>

    <!-- ç»Ÿè®¡é¡µ -->
    <div class="page" id="page-stats">
        <div class="chart-container">
            <div class="chart-title">æ¸…é†’è¯„åˆ†è¶‹åŠ¿ï¼ˆ14å¤©ï¼‰</div>
            <div class="chart-wrapper">
                <canvas id="scoreChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-title">è„‘é¸£å˜åŒ–è¶‹åŠ¿</div>
            <div class="chart-wrapper">
                <canvas id="tinnitusChart"></canvas>
            </div>
        </div>

        <div class="card">
            <div class="stat-item">
                <span class="stat-icon" style="color: #70AD47;">âœ“</span>
                <span class="stat-label">å¹³å‡æ¸…é†’è¯„åˆ†</span>
                <span class="stat-value" id="avgScore">-</span>
            </div>
            <div class="divider"></div>
            <div class="stat-item">
                <span class="stat-icon" style="color: #5B9BD5;">â—</span>
                <span class="stat-label">æœ€é•¿è¿ç»­å¤©æ•°</span>
                <span class="stat-value" id="maxStreakDays">0</span>
            </div>
            <div class="divider"></div>
            <div class="stat-item">
                <span class="stat-icon" style="color: #999;">â—</span>
                <span class="stat-label">æ€»æ‰“å¡å¤©æ•°</span>
                <span class="stat-value" id="totalDays">0</span>
            </div>
        </div>
    </div>

    <!-- æ–¹æ¡ˆé¡µ -->
    <div class="page" id="page-plan">
        <div class="section">
            <div class="section-title" onclick="toggleSection(this)">
                <span>ğŸ’¼ åŠå…¬ç¯å¢ƒç®¡ç†</span>
                <span>â–¼</span>
            </div>
            <div class="section-content">
                <div class="section-item"><strong>å·¥ä½æ”¹é€ ï¼š</strong>å«é«˜æ˜¾ç¤ºå™¨ï¼Œè§†çº¿å¹³é½</div>
                <div class="section-item"><strong>æ¸©åº¦é˜²å¾¡ï¼š</strong>æˆ·å¤–å¸¦å›´å·¾ï¼Œä¸‹è‚¢ä¿æš–</div>
                <div class="section-item"><strong>å™ªéŸ³ç®¡ç†ï¼š</strong>ä¸»åŠ¨é™å™ªè€³æœº</div>
                <div class="section-item"><strong>æ²æµ´è°ƒèŠ‚ï¼š</strong>ç¡å‰2å°æ—¶ï¼Œæ¸©å‡‰æ°´æ”¶å°¾</div>
            </div>
        </div>

        <div class="section">
            <div class="section-title" onclick="toggleSection(this)">
                <span>ğŸƒ æ¯æ—¥è®­ç»ƒ</span>
                <span>â–¼</span>
            </div>
            <div class="section-content">
                <div class="section-item"><strong>æ”¶é¢Œè®­ç»ƒï¼š</strong>æ¯å°æ—¶1ç»„Ã—10æ¬¡ï¼ˆå‘åæ”¶ä¸‹å·´ï¼‰</div>
                <div class="section-item"><strong>èƒ¸æ¤ä¼¸å±•ï¼š</strong>ä¸‹åˆ3ç‚¹ï¼Œåˆ©ç”¨æ¤…èƒŒå‘åä¼¸å±•</div>
                <div class="section-item"><strong>è‚¡å››å¤´è‚Œæ¾è§£ï¼š</strong>ç¡å‰æ³¡æ²«è½´æ»šå¤§è…¿å‰ä¾§</div>
            </div>
        </div>

        <div class="section">
            <div class="section-title" onclick="toggleSection(this)">
                <span>ğŸ˜´ ç¡çœ ä¼˜åŒ–</span>
                <span>â–¼</span>
            </div>
            <div class="section-content">
                <div class="section-item"><strong>ç‰©ç†å¹²é¢„ï¼š</strong>ç”Ÿç†ç›æ°´æ´—é¼» + é¼»è´´</div>
                <div class="section-item"><strong>é‡åŠ›å¹²é¢„ï¼š</strong>10%ä½“é‡é‡åŠ›æ¯¯</div>
                <div class="section-item"><strong>ä½“ä½å¹²é¢„ï¼š</strong>ä¾§å§ï¼ŒåŒè…¿å¤¹è½¯æ•</div>
                <div class="section-item"><strong>ç¥ç»è°ƒæ¯ï¼š</strong>4-7-8å‘¼å¸æ³•ï¼ˆå¸4æ†‹7å‘¼8ï¼‰</div>
            </div>
        </div>

        <div class="section">
            <div class="section-title" onclick="toggleSection(this)">
                <span>âš ï¸ ä¸“å®¶æé†’</span>
                <span>â–¼</span>
            </div>
            <div class="section-content">
                <div class="section-item">â€¢ è°ƒæ•´ååº”ï¼šè„‘é¸£æ³¢åŠ¨æ˜¯æ­£å¸¸çš„</div>
                <div class="section-item">â€¢ å¾ªåºæ¸è¿›ï¼šæ±‚é«˜é¢‘æ¬¡ï¼Œä¸æ±‚å¹…åº¦å¤§</div>
                <div class="section-item">â€¢ é•¿æœŸé¢„æœŸï¼šæå‡è€å—åº¦å’Œèˆ’é€‚åº¦</div>
            </div>
        </div>
    </div>

    <!-- æˆ‘çš„é¡µ -->
    <div class="page" id="page-profile">
        <div class="card user-card">
            <div class="user-avatar">ğŸ‘¤</div>
            <div class="user-name">åº·å¤è€…</div>
            <div class="user-days" id="profileDays">åšæŒè®°å½•ç¬¬ 0 å¤©</div>
        </div>

        <div class="card">
            <div class="menu-item" onclick="showPage('stats')">
                <span class="menu-text">æ•°æ®ç»Ÿè®¡</span>
                <span class="menu-arrow">â†’</span>
            </div>
            <div class="divider"></div>
            <div class="menu-item" onclick="exportData()">
                <span class="menu-text">å¯¼å‡ºæ•°æ®</span>
                <span class="menu-arrow">â†’</span>
            </div>
            <div class="divider"></div>
            <div class="menu-item" onclick="showAbout()">
                <span class="menu-text">å…³äºæ–¹æ¡ˆ</span>
                <span class="menu-arrow">â†’</span>
            </div>
        </div>

        <div class="card">
            <div class="menu-item">
                <span class="menu-text">æé†’è®¾ç½®</span>
                <label class="switch">
                    <input type="checkbox" id="reminderSwitch" checked onchange="toggleReminder()">
                    <span class="slider-switch"></span>
                </label>
            </div>
        </div>

        <div class="card">
            <div class="footer-text">
                åº·å¤è¿½è¸ª v1.0<br>
                æ•°æ®ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨å¯¼èˆª -->
    <div class="tabbar">
        <div class="tab-item active" onclick="showPage('home')">
            <div class="tab-icon">ğŸ </div>
            <div>é¦–é¡µ</div>
        </div>
        <div class="tab-item" onclick="showPage('history')">
            <div class="tab-icon">ğŸ“‹</div>
            <div>è®°å½•</div>
        </div>
        <div class="tab-item" onclick="showPage('plan')">
            <div class="tab-icon">ğŸ“–</div>
            <div>æ–¹æ¡ˆ</div>
        </div>
        <div class="tab-item" onclick="showPage('profile')">
            <div class="tab-icon">ğŸ‘¤</div>
            <div>æˆ‘çš„</div>
        </div>
    </div>

    <script>
        // ============= æ•°æ®å­˜å‚¨ =============
        const STORAGE_KEY_RECORDS = 'rehab_records';
        const STORAGE_KEY_SETTINGS = 'rehab_settings';
        const STORAGE_KEY_REMINDERS = 'rehab_reminders';

        // è·å–æ‰€æœ‰è®°å½•
        function getRecords() {
            const data = localStorage.getItem(STORAGE_KEY_RECORDS);
            return data ? JSON.parse(data) : [];
        }

        // ä¿å­˜è®°å½•
        function saveRecord(record) {
            let records = getRecords();
            const today = record.date;

            // æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²æœ‰è®°å½•
            const existingIndex = records.findIndex(r => r.date === today);

            if (existingIndex >= 0) {
                // æ›´æ–°ä»Šå¤©çš„è®°å½•
                records[existingIndex] = record;
            } else {
                // æ·»åŠ æ–°è®°å½•
                records.unshift(record);
            }

            localStorage.setItem(STORAGE_KEY_RECORDS, JSON.stringify(records));
            return records;
        }

        // è·å–ä»Šå¤©çš„è®°å½•
        function getTodayRecord() {
            const records = getRecords();
            const today = new Date().toISOString().split('T')[0];
            return records.find(r => r.date === today);
        }

        // è®¡ç®—è¿ç»­æ‰“å¡å¤©æ•°
        function getStreakDays() {
            const records = getRecords();
            if (records.length === 0) return 0;

            let streak = 0;
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            for (let i = 0; i < records.length; i++) {
                const recordDate = new Date(records[i].date);
                recordDate.setHours(0, 0, 0, 0);

                const diffDays = Math.floor((today - recordDate) / (1000 * 60 * 60 * 24));

                if (diffDays === i) {
                    streak++;
                } else {
                    break;
                }
            }

            return streak;
        }

        // è·å–è®¾ç½®
        function getSettings() {
            const data = localStorage.getItem(STORAGE_KEY_SETTINGS);
            return data ? JSON.parse(data) : { reminderEnabled: true };
        }

        // ä¿å­˜è®¾ç½®
        function saveSettings(settings) {
            localStorage.setItem(STORAGE_KEY_SETTINGS, JSON.stringify(settings));
        }

        // è·å–æé†’çŠ¶æ€
        function getReminders() {
            const data = localStorage.getItem(STORAGE_KEY_REMINDERS);
            return data ? JSON.parse(data) : {};
        }

        // ä¿å­˜æé†’çŠ¶æ€
        function saveReminders(reminders) {
            localStorage.setItem(STORAGE_KEY_REMINDERS, JSON.stringify(reminders));
        }

        // ============= UI äº¤äº’ =============
        let counterValue = 5;
        let tinnitusVolume = 2;
        let tinnitusFreq = 1;

        // æ›´æ–°å½“å‰æ—¥æœŸ
        function updateCurrentDate() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('zh-CN', options);
        }

        // åˆ‡æ¢é¡µé¢
        function showPage(pageName) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });

            const targetPage = document.getElementById('page-' + pageName);
            if (targetPage) {
                targetPage.classList.add('active');
            }

            const titles = {
                'home': 'åº·å¤è¿½è¸ª',
                'checkin': 'æ¯æ—¥æ‰“å¡',
                'history': 'å†å²è®°å½•',
                'stats': 'æ•°æ®ç»Ÿè®¡',
                'plan': 'åº·å¤æ–¹æ¡ˆ',
                'profile': 'æˆ‘çš„'
            };
            document.getElementById('header').textContent = titles[pageName] || 'åº·å¤è¿½è¸ª';

            document.querySelectorAll('.tab-item').forEach(tab => {
                tab.classList.remove('active');
            });

            const tabMap = {
                'home': 0,
                'history': 1,
                'plan': 2,
                'profile': 3,
                'checkin': 0,
                'stats': 1
            };
            const tabs = document.querySelectorAll('.tab-item');
            if (tabs[tabMap[pageName]]) {
                tabs[tabMap[pageName]].classList.add('active');
            }

            // é¡µé¢åˆ‡æ¢æ—¶åˆ·æ–°æ•°æ®
            if (pageName === 'home') {
                loadHomePage();
            } else if (pageName === 'history') {
                loadRecords();
            } else if (pageName === 'stats') {
                loadStats();
            } else if (pageName === 'profile') {
                loadProfile();
            } else if (pageName === 'checkin') {
                loadCheckinPage();
            }
        }

        // åŠ è½½é¦–é¡µæ•°æ®
        function loadHomePage() {
            const streakDays = getStreakDays();
            document.getElementById('streakDays').textContent = streakDays + ' å¤©';

            const todayRecord = getTodayRecord();
            if (todayRecord) {
                document.getElementById('checkinPrompt').textContent = 'ä»Šå¤©å·²æ‰“å¡ âœ“';
            } else {
                document.getElementById('checkinPrompt').textContent = 'ä»Šå¤©æ‰“å¡äº†å—ï¼Ÿ';
            }

            // åŠ è½½æé†’çŠ¶æ€
            const reminders = getReminders();
            document.querySelectorAll('.reminder-item .checkbox').forEach(checkbox => {
                const reminderType = checkbox.dataset.reminder;
                if (reminders[reminderType]) {
                    checkbox.classList.add('checked');
                } else {
                    checkbox.classList.remove('checked');
                }
            });
        }

        // åŠ è½½æ‰“å¡é¡µé¢
        function loadCheckinPage() {
            const todayRecord = getTodayRecord();
            if (todayRecord) {
                // åŠ è½½ä»Šå¤©çš„è®°å½•
                document.getElementById('scoreSlider').value = todayRecord.score;
                document.getElementById('scoreDisplay').textContent = todayRecord.score;
                counterValue = todayRecord.kneeClicks || 0;
                document.getElementById('counterValue').textContent = counterValue;
                tinnitusVolume = todayRecord.tinnitusVolume || 2;
                tinnitusFreq = todayRecord.tinnitusFreq || 1;
                document.getElementById('notesInput').value = todayRecord.notes || '';

                // æ›´æ–°å•é€‰æŒ‰é’®çŠ¶æ€
                updateRadioButtons('volumeGroup', tinnitusVolume);
                updateRadioButtons('freqGroup', tinnitusFreq);
            } else {
                // é‡ç½®è¡¨å•
                document.getElementById('scoreSlider').value = 7;
                document.getElementById('scoreDisplay').textContent = '7';
                counterValue = 5;
                document.getElementById('counterValue').textContent = counterValue;
                tinnitusVolume = 2;
                tinnitusFreq = 1;
                document.getElementById('notesInput').value = '';
                updateRadioButtons('volumeGroup', 2);
                updateRadioButtons('freqGroup', 1);
            }
        }

        // æ›´æ–°å•é€‰æŒ‰é’®çŠ¶æ€
        function updateRadioButtons(groupId, selectedIndex) {
            const group = document.getElementById(groupId);
            group.querySelectorAll('.radio-btn').forEach((btn, index) => {
                if (index === selectedIndex) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });
        }

        // æ›´æ–°è¯„åˆ†
        function updateScore() {
            const slider = document.getElementById('scoreSlider');
            document.getElementById('scoreDisplay').textContent = slider.value;
        }

        // é€‰æ‹©å•é€‰æŒ‰é’®
        function selectRadio(groupId, element, value) {
            const group = document.getElementById(groupId);
            group.querySelectorAll('.radio-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            element.classList.add('selected');

            if (groupId === 'volumeGroup') {
                tinnitusVolume = value;
            } else if (groupId === 'freqGroup') {
                tinnitusFreq = value;
            }
        }

        // æ›´æ–°è®¡æ•°å™¨
        function updateCounter(delta) {
            counterValue = Math.max(0, counterValue + delta);
            document.getElementById('counterValue').textContent = counterValue;
        }

        // åˆ‡æ¢å¤é€‰æ¡†
        function toggleCheck(element) {
            element.classList.toggle('checked');
            const reminderType = element.dataset.reminder;
            const reminders = getReminders();
            reminders[reminderType] = element.classList.contains('checked');
            saveReminders(reminders);
        }

        // åˆ‡æ¢æŠ˜å åŒºåŸŸ
        function toggleSection(element) {
            const content = element.nextElementSibling;
            content.classList.toggle('show');
            const arrow = element.querySelector('span:last-child');
            arrow.textContent = content.classList.contains('show') ? 'â–²' : 'â–¼';
        }

        // ä¿å­˜æ‰“å¡
        function saveCheckin() {
            const now = new Date();
            const today = now.toISOString().split('T')[0];

            const record = {
                date: today,
                score: parseInt(document.getElementById('scoreSlider').value),
                tinnitusVolume: tinnitusVolume,
                tinnitusFreq: tinnitusFreq,
                kneeClicks: counterValue,
                notes: document.getElementById('notesInput').value,
                timestamp: now.getTime()
            };

            saveRecord(record);
            showToast('æ‰“å¡ä¿å­˜æˆåŠŸï¼');
            setTimeout(() => showPage('home'), 1000);
        }

        // åŠ è½½è®°å½•åˆ—è¡¨
        function loadRecords() {
            const records = getRecords();
            const container = document.getElementById('recordsCard');

            if (records.length === 0) {
                container.innerHTML = `
                    <div class="empty">
                        <div class="empty-icon">ğŸ“‹</div>
                        <div>è¿˜æ²¡æœ‰æ‰“å¡è®°å½•</div>
                        <div style="font-size: 12px; margin-top: 10px;">å¼€å§‹ç¬¬ä¸€æ¬¡æ‰“å¡å§</div>
                    </div>
                `;
                return;
            }

            const volumeOptions = ['æ— ', 'è½»å¾®', 'ä¸­ç­‰', 'ä¸¥é‡'];
            const freqOptions = ['æ— ', 'å¶å°”', 'æŒç»­', 'æ•´å¤œ'];

            let html = '';
            records.forEach(record => {
                const date = new Date(record.date);
                const month = date.getMonth() + 1;
                const day = date.getDate();
                const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
                const weekday = weekdays[date.getDay()];

                html += `
                    <div class="record-item" onclick="viewRecord('${record.date}')">
                        <div class="record-date">${month}æœˆ${day}æ—¥ ${weekday}</div>
                        <div class="record-score">æ¸…é†’è¯„åˆ†: ${record.score}</div>
                        <div class="record-details">
                            è„‘é¸£: ${volumeOptions[record.tinnitusVolume]}(${freqOptions[record.tinnitusFreq]}) | è†ç›–å¼¹å“: ${record.kneeClicks}æ¬¡
                        </div>
                        ${record.notes ? `<div class="record-notes">${record.notes}</div>` : ''}
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // æŸ¥çœ‹è®°å½•è¯¦æƒ…
        function viewRecord(date) {
            const records = getRecords();
            const record = records.find(r => r.date === date);
            if (!record) return;

            const volumeOptions = ['æ— ', 'è½»å¾®', 'ä¸­ç­‰', 'ä¸¥é‡'];
            const freqOptions = ['æ— ', 'å¶å°”', 'æŒç»­', 'æ•´å¤œ'];
            const dateObj = new Date(record.date);
            const dateStr = `${dateObj.getMonth() + 1}æœˆ${dateObj.getDate()}æ—¥`;

            const content = `æ¸…é†’è¯„åˆ†: ${record.score}\nè„‘é¸£éŸ³é‡: ${volumeOptions[record.tinnitusVolume]}\nè„‘é¸£é¢‘ç‡: ${freqOptions[record.tinnitusFreq]}\nè†ç›–å¼¹å“: ${record.kneeClicks}æ¬¡\n${record.notes ? 'å¤‡æ³¨: ' + record.notes : ''}`;

            // ä½¿ç”¨è‡ªå®šä¹‰å¼¹çª—
            alert(dateStr + '\n\n' + content);
        }

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        function loadStats() {
            const records = getRecords();

            if (records.length === 0) {
                document.getElementById('avgScore').textContent = '-';
                document.getElementById('maxStreakDays').textContent = '0';
                document.getElementById('totalDays').textContent = '0';
                return;
            }

            // è®¡ç®—å¹³å‡æ¸…é†’è¯„åˆ†
            const totalScore = records.reduce((sum, r) => sum + r.score, 0);
            const avgScore = (totalScore / records.length).toFixed(1);

            // è®¡ç®—æœ€é•¿è¿ç»­å¤©æ•°
            let maxStreak = 0;
            let currentStreak = 0;
            const sortedRecords = [...records].sort((a, b) => new Date(a.date) - new Date(b.date));

            for (let i = 0; i < sortedRecords.length; i++) {
                if (i === 0) {
                    currentStreak = 1;
                } else {
                    const prevDate = new Date(sortedRecords[i - 1].date);
                    const currDate = new Date(sortedRecords[i].date);
                    const diffDays = (currDate - prevDate) / (1000 * 60 * 60 * 24);

                    if (diffDays === 1) {
                        currentStreak++;
                    } else {
                        currentStreak = 1;
                    }
                }

                if (currentStreak > maxStreak) {
                    maxStreak = currentStreak;
                }
            }

            document.getElementById('avgScore').textContent = avgScore;
            document.getElementById('maxStreakDays').textContent = maxStreak;
            document.getElementById('totalDays').textContent = records.length;

            // ç»˜åˆ¶å›¾è¡¨
            drawCharts(records.slice(0, 14).reverse());
        }

        // ç»˜åˆ¶å›¾è¡¨
        function drawCharts(records) {
            if (records.length === 0) return;

            // æ¸…ç©ºæ—§å›¾è¡¨
            const scoreChart = Chart.getChart('scoreChart');
            const tinnitusChart = Chart.getChart('tinnitusChart');
            if (scoreChart) scoreChart.destroy();
            if (tinnitusChart) tinnitusChart.destroy();

            // å‡†å¤‡æ•°æ®
            const labels = records.map(r => {
                const date = new Date(r.date);
                return `${date.getMonth() + 1}/${date.getDate()}`;
            });
            const scores = records.map(r => r.score);
            const volumes = records.map(r => r.tinnitusVolume);

            // ç»˜åˆ¶æ¸…é†’è¯„åˆ†æŠ˜çº¿å›¾
            new Chart(document.getElementById('scoreChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'æ¸…é†’è¯„åˆ†',
                        data: scores,
                        borderColor: '#5B9BD5',
                        backgroundColor: 'rgba(91, 155, 213, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            min: 1,
                            max: 10,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // ç»˜åˆ¶è„‘é¸£è¶‹åŠ¿æŸ±çŠ¶å›¾
            new Chart(document.getElementById('tinnitusChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'è„‘é¸£éŸ³é‡',
                        data: volumes,
                        backgroundColor: volumes.map(v => {
                            const colors = ['#70AD47', '#FFC000', '#FF5722', '#D32F2F'];
                            return colors[v];
                        })
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            min: 0,
                            max: 3,
                            ticks: {
                                callback: function(value) {
                                    return ['æ— ', 'è½»å¾®', 'ä¸­ç­‰', 'ä¸¥é‡'][value];
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // åŠ è½½ä¸ªäººä¸­å¿ƒ
        function loadProfile() {
            const records = getRecords();
            document.getElementById('profileDays').textContent = `åšæŒè®°å½•ç¬¬ ${records.length} å¤©`;

            const settings = getSettings();
            document.getElementById('reminderSwitch').checked = settings.reminderEnabled !== false;
        }

        // åˆ‡æ¢æé†’å¼€å…³
        function toggleReminder() {
            const enabled = document.getElementById('reminderSwitch').checked;
            const settings = getSettings();
            settings.reminderEnabled = enabled;
            saveSettings(settings);
            showToast(enabled ? 'æé†’å·²å¼€å¯' : 'æé†’å·²å…³é—­');
        }

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            const records = getRecords();

            if (records.length === 0) {
                showToast('æš‚æ— æ•°æ®å¯å¯¼å‡º');
                return;
            }

            // ç”Ÿæˆ CSV æ ¼å¼
            let csv = 'æ—¥æœŸ,æ¸…é†’è¯„åˆ†,è„‘é¸£éŸ³é‡,è„‘é¸£é¢‘ç‡,è†ç›–å¼¹å“æ¬¡æ•°,å¤‡æ³¨\n';
            const volumeOptions = ['æ— ', 'è½»å¾®', 'ä¸­ç­‰', 'ä¸¥é‡'];
            const freqOptions = ['æ— ', 'å¶å°”', 'æŒç»­', 'æ•´å¤œ'];

            records.forEach(record => {
                csv += `${record.date},${record.score},${volumeOptions[record.tinnitusVolume]},${freqOptions[record.tinnitusFreq]},${record.kneeClicks},"${record.notes || ''}"\n`;
            });

            // åˆ›å»º Blob å¹¶ä¸‹è½½
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `åº·å¤è¿½è¸ªæ•°æ®_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();

            showToast('æ•°æ®å·²å¯¼å‡º');
        }

        // æ˜¾ç¤ºå…³äºä¿¡æ¯
        function showAbout() {
            alert('åº·å¤è¿½è¸ª v1.0\n\nåŸºäºã€Šç»¼åˆåº·å¤ä¸ç³»ç»Ÿä¼˜åŒ–æ–¹æ¡ˆã€‹å¼€å‘\nç”¨äºè¾…åŠ©åº·å¤ä¹ æƒ¯çš„å…»æˆå’Œæ•°æ®è¿½è¸ª\n\næ•°æ®ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°ï¼Œè¯·å®šæœŸå¤‡ä»½å¯¼å‡º');
        }

        // Toast æç¤º
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }

        // ============= åˆå§‹åŒ– =============
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentDate();
            loadHomePage();
        });
    </script>
</body>
</html>

